name: CI

on:
  push:
    branches: [main]
    tags: ["v*", "beta-*"]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUST_TOOLCHAIN: "stable"

# Tags cancel main if in progress, but main never cancels tags
# Tags have priority as they represent releases
concurrency:
  group: CI
  cancel-in-progress: ${{ startsWith(github.ref, 'refs/tags/') }}

# Minimal top-level permissions — jobs override as needed
permissions:
  contents: read

jobs:
  # ===========================================================================
  # Detect changed paths to skip unnecessary jobs
  # For tags, all outputs are forced to 'true' (always run everything)
  # ===========================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      rust: ${{ startsWith(github.ref, 'refs/tags/') || steps.filter.outputs.rust }}
      ci: ${{ startsWith(github.ref, 'refs/tags/') || steps.filter.outputs.ci }}
      demo: ${{ startsWith(github.ref, 'refs/tags/') || steps.filter.outputs.demo }}
      docker: ${{ startsWith(github.ref, 'refs/tags/') || steps.filter.outputs.docker }}
      docs: ${{ startsWith(github.ref, 'refs/tags/') || steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v6

      - uses: dorny/paths-filter@v3
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        id: filter
        with:
          filters: |
            rust:
              - 'src/**'
              - 'tests/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'benches/**'
              - 'deny.toml'
              - '.cargo/**'
              - 'assets/**'
            ci:
              - '.github/workflows/**'
            demo:
              - 'contrib/demo.tape'
              - 'contrib/wizard.tape'
            docker:
              - 'Containerfile'
              - 'Containerfile.cross'
              - 'Containerfile.alpine'
              - 'Containerfile.package'
              - '.trivyignore'
              - '.grype.yaml'
            docs:
              - '*.md'
              - 'docs/**'
              - 'LICENSE'

  # ===========================================================================
  # Lint: fmt + clippy + hadolint + commitlint
  # Runs on: main/PR (if changed), all tags (always)
  # ===========================================================================
  lint:
    name: Lint
    needs: changes
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Rust ${{ env.RUST_TOOLCHAIN }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-unified-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-unified-

      - name: cargo fmt
        run: cargo fmt --all -- --check

      - name: Verify E2E test sync
        run: ./scripts/check-ci-test-sync.sh

      - name: cargo clippy
        run: cargo clippy --all-targets -- -D warnings

      - name: Install commitlint
        if: github.event_name == 'pull_request'
        run: npm install -g @commitlint/cli @commitlint/config-conventional

      - name: Validate commits
        if: github.event_name == 'pull_request'
        run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to HEAD

  # ===========================================================================
  # Docker Lint: Hadolint on Containerfiles
  # Runs on: main/PR (if changed), skipped on tags
  # ===========================================================================
  docker-lint:
    name: Docker Lint
    needs: changes
    if: needs.changes.outputs.docker == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Hadolint (Containerfile)
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: Containerfile

      - name: Hadolint (Containerfile.cross)
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: Containerfile.cross

      - name: Hadolint (Containerfile.alpine)
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: Containerfile.alpine

      - name: Hadolint (Containerfile.package)
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: Containerfile.package

  # ===========================================================================
  # Test: unit + integration
  # Runs on: main/PR (if changed), all tags (always)
  # ===========================================================================
  test:
    name: Test
    needs: changes
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Free disk space
        run: sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc 2>/dev/null || true

      - name: Install Rust ${{ env.RUST_TOOLCHAIN }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-unified-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-unified-

      - name: Run all tests
        run: cargo test --all-targets || cargo test --all-targets

  # ===========================================================================
  # E2E Tests: parallelized into 4 groups for faster execution
  # Runs on: main/PR (if changed), all tags (always)
  # ===========================================================================
  e2e-tests:
    name: E2E (${{ matrix.name }})
    needs: changes
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: SSH & SOCKS5
            tests: >-
              --test e2e_auth
              --test e2e_ssh_session
              --test e2e_socks5_server
              --test e2e_socks5_standalone
              --test e2e_socks5_timeout
              --test e2e_forwarding
              --test e2e_rejection
          - name: ACL & Security
            tests: >-
              --test e2e_acl_fqdn
              --test e2e_acl_subnet
              --test e2e_acl_combined
              --test e2e_acl_ipv6
              --test e2e_autoban
              --test e2e_shell
              --test e2e_shell_commands
              --test e2e_upstream_proxy
          - name: API & Dashboard
            tests: >-
              --test e2e_api_dashboard
              --test e2e_api_users_details
              --test e2e_api_audit_improvements
              --test e2e_api_groups
              --test e2e_api_sessions
              --test e2e_quota_api
              --test e2e_status
              --test e2e_cli
              --test e2e_wizard
          - name: Integrations
            tests: >-
              --test e2e_audit_trail
              --test e2e_webhook
              --test e2e_webhook_retry
              --test e2e_sse_ticket
              --test e2e_sse_payload
              --test e2e_ws
              --test e2e_metrics_server
              --test e2e_backup_restore
              --test e2e_persistence
              --test e2e_reload
              --test e2e_performance
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust ${{ env.RUST_TOOLCHAIN }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-unified-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-unified-

      - name: Run E2E tests
        run: cargo test ${{ matrix.tests }}

  # ===========================================================================
  # Test MSRV: verify compilation with minimum supported Rust version
  # Runs on: main/PR and tags
  # ===========================================================================
  test-msrv:
    name: Test MSRV (1.88)
    needs: changes
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust 1.88
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.88"

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-msrv-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-msrv-

      - name: Check MSRV compilation
        run: cargo check

  # ===========================================================================
  # Coverage: cargo-tarpaulin
  # Runs on: main/PR and tags
  # ===========================================================================
  coverage:
    name: Coverage
    needs: changes
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust ${{ env.RUST_TOOLCHAIN }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: llvm-tools-preview

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-unified-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-unified-

      - name: Cache cargo tools
        uses: actions/cache@v5
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-tools-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: ${{ runner.os }}-cargo-tools-

      - name: Install cargo-llvm-cov
        run: cargo install cargo-llvm-cov --locked || true

      - name: Generate coverage
        run: cargo llvm-cov --lcov --output-path lcov.info --lib --test unit
        timeout-minutes: 10

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          fail_ci_if_error: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ===========================================================================
  # Security: cargo-audit + cargo-deny
  # Runs on: main/PR (if changed), all tags (always)
  # ===========================================================================
  security:
    name: Security
    needs: changes
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust ${{ env.RUST_TOOLCHAIN }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache cargo tools
        uses: actions/cache@v5
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-tools-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: ${{ runner.os }}-cargo-tools-

      - name: Install security tools
        run: |
          cargo install cargo-audit --locked || true
          cargo install cargo-deny --locked || true

      - name: cargo audit
        run: cargo audit

      - name: cargo deny
        run: cargo deny check

  # ===========================================================================
  # SARIF: clippy results in GitHub Security tab
  # Runs on: push to main only (not PRs, not tags)
  # ===========================================================================
  sarif:
    name: SARIF Upload
    needs: changes
    if: >-
      github.event_name == 'push'
      && !startsWith(github.ref, 'refs/tags/')
      && (needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true')
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust ${{ env.RUST_TOOLCHAIN }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: clippy

      - name: Cache cargo tools
        uses: actions/cache@v5
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-tools-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: ${{ runner.os }}-cargo-tools-

      - name: Install clippy-sarif and sarif-fmt
        run: |
          cargo install clippy-sarif --locked || true
          cargo install sarif-fmt --locked || true

      - name: Run clippy (SARIF)
        run: >
          cargo clippy --all-targets --message-format=json |
          clippy-sarif | tee results.sarif | sarif-fmt
        continue-on-error: true

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif

  # ===========================================================================
  # E2E Browser: headless Chrome via Podman
  # Runs on: main/PR and tags
  # ===========================================================================
  e2e-browser:
    name: E2E Browser Tests
    needs: changes
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true' || needs.changes.outputs.demo == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust ${{ env.RUST_TOOLCHAIN }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-unified-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-unified-

      - name: Verify Podman is available
        run: podman --version

      - name: Pull Chrome Headless image
        run: podman pull docker.io/chromedp/headless-shell:latest

      - name: Run browser E2E tests
        run: cargo test --test e2e_browser_dashboard -- --nocapture
        env:
          RUST_LOG: debug

      - name: Capture dashboard screenshots
        run: |
          mkdir -p screenshots
          SCREENSHOT_DIR=screenshots cargo test --test e2e_browser_screenshots -- --nocapture
        env:
          RUST_LOG: debug

      - name: Upload screenshots artifact
        uses: actions/upload-artifact@v6
        with:
          name: dashboard-screenshots
          path: screenshots/
          if-no-files-found: ignore
          retention-days: 1

      - name: Cleanup Chrome containers
        if: always()
        run: |
          podman ps -aq --filter name=sks5-chrome | xargs -r podman rm -f 2>/dev/null || true
          podman image rm docker.io/chromedp/headless-shell:latest 2>/dev/null || true

  # ===========================================================================
  # VHS: generate terminal demo GIF
  # Runs on: main/PR and tags
  # ===========================================================================
  vhs-demo:
    name: Generate Terminal Demo
    needs: [changes]
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.demo == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust ${{ env.RUST_TOOLCHAIN }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-unified-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-unified-

      - name: Build sks5
        run: cargo build --release

      - name: Make binary executable
        run: chmod +x target/release/sks5

      - name: Install VHS + deps
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg fonts-jetbrains-mono
          curl -fsSL -o /tmp/ttyd "https://github.com/tsl0922/ttyd/releases/latest/download/ttyd.x86_64"
          sudo install /tmp/ttyd /usr/local/bin/ttyd
          VHS_VERSION=$(curl -fsSL https://api.github.com/repos/charmbracelet/vhs/releases/latest | grep -oP '"tag_name":\s*"v\K[^"]+')
          curl -fsSL "https://github.com/charmbracelet/vhs/releases/download/v${VHS_VERSION}/vhs_${VHS_VERSION}_Linux_x86_64.tar.gz" | \
            sudo tar -xz -C /usr/local/bin --strip-components=1 "vhs_${VHS_VERSION}_Linux_x86_64/vhs"

      - name: Add sks5 to PATH
        run: |
          mkdir -p ~/.local/bin
          install target/release/sks5 ~/.local/bin/sks5
          echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc

      - name: Generate demo GIF
        run: vhs contrib/demo.tape

      - name: Generate wizard GIF
        run: vhs contrib/wizard.tape

      - name: Generate wizard-interactive GIF
        run: vhs contrib/wizard-interactive.tape

      - name: Upload demo GIF
        uses: actions/upload-artifact@v6
        with:
          name: demo-gif
          path: contrib/demo.gif
          retention-days: 1

      - name: Upload wizard GIF
        uses: actions/upload-artifact@v6
        with:
          name: wizard-gif
          path: contrib/wizard.gif
          retention-days: 1

      - name: Upload wizard-interactive GIF
        uses: actions/upload-artifact@v6
        with:
          name: wizard-interactive-gif
          path: contrib/wizard-interactive.gif
          retention-days: 1

      - name: Stop sks5
        if: always()
        run: pkill sks5 || true

  # ===========================================================================
  # Verify: tag matches Cargo.toml version (v* release only)
  # ===========================================================================
  verify-version:
    name: Verify version matches tag
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Verify version matches tag
        run: |
          CARGO_VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*= "//;s/"//')
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: Cargo.toml version ($CARGO_VERSION) doesn't match tag ($TAG_VERSION)"
            exit 1
          fi
          echo "Version verified: $CARGO_VERSION == $TAG_VERSION"

  # ===========================================================================
  # Cross Build: cross-compile for all targets (PRs, main, and tags)
  # Same pipeline everywhere — regressions caught immediately
  # ===========================================================================
  cross-build:
    name: Cross Build
    needs: changes
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.docker == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            archive: sks5-x86_64-linux-gnu.tar.gz
          - target: x86_64-unknown-linux-musl
            archive: sks5-x86_64-linux-musl.tar.gz
          - target: aarch64-unknown-linux-gnu
            archive: sks5-aarch64-linux-gnu.tar.gz
          - target: aarch64-unknown-linux-musl
            archive: sks5-aarch64-linux-musl.tar.gz
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cross
        run: cargo install cross

      - name: Build
        run: cross build --release --target ${{ matrix.target }}

      - name: Strip binary
        run: |
          if command -v strip &> /dev/null; then
            strip target/${{ matrix.target }}/release/sks5 2>/dev/null || true
          fi

      - name: Package
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/sks5 dist/
          cp README.md LICENSE dist/ 2>/dev/null || true
          cd dist && tar czf ../${{ matrix.archive }} *

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.archive }}
          path: ${{ matrix.archive }}

  # ===========================================================================
  # Extras: generate shell completions and man page (v* release only)
  # ===========================================================================
  extras:
    name: Generate extras
    needs: cross-build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download x86_64-gnu artifact
        uses: actions/download-artifact@v7
        with:
          name: sks5-x86_64-linux-gnu.tar.gz
          path: /tmp/artifacts

      - name: Extract binary
        run: |
          mkdir -p target/release
          tar xzf /tmp/artifacts/sks5-x86_64-linux-gnu.tar.gz -C target/release
          chmod +x target/release/sks5

      - name: Generate completions
        run: |
          mkdir -p completions
          target/release/sks5 completions bash > completions/sks5.bash
          target/release/sks5 completions zsh > completions/_sks5
          target/release/sks5 completions fish > completions/sks5.fish

      - name: Generate man page
        run: |
          mkdir -p man
          target/release/sks5 manpage > man/sks5.1

      - name: Upload completions
        uses: actions/upload-artifact@v6
        with:
          name: completions
          path: completions/

      - name: Upload man page
        uses: actions/upload-artifact@v6
        with:
          name: manpage
          path: man/

  # ===========================================================================
  # SBOM: generate CycloneDX Software Bill of Materials (v* release only)
  # ===========================================================================
  sbom:
    name: Generate SBOM
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo tools
        uses: actions/cache@v5
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-cargo-tools-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: ${{ runner.os }}-cargo-tools-

      - name: Install cargo-cyclonedx
        run: cargo install cargo-cyclonedx --locked || true

      - name: Generate CycloneDX SBOM (JSON)
        run: cargo cyclonedx -f json

      - name: Rename SBOM for release
        run: |
          # cargo-cyclonedx outputs to bom.json or <crate>.cdx.json
          # Find the generated file and rename for the release
          SBOM_FILE=$(find . -maxdepth 2 -name '*.cdx.json' -o -name 'bom.json' | head -1)
          if [ -z "$SBOM_FILE" ]; then
            echo "ERROR: SBOM file not found"
            ls -la *.json 2>/dev/null || true
            exit 1
          fi
          # Only copy if the file is not already named sks5.cdx.json
          if [ "$SBOM_FILE" != "./sks5.cdx.json" ]; then
            cp "$SBOM_FILE" sks5.cdx.json
          fi
          echo "SBOM generated: sks5.cdx.json"

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v6
        with:
          name: sbom
          path: sks5.cdx.json

  # ===========================================================================
  # Release: checksums, cosign signing, GitHub Release (v* release only)
  # ---------------------------------------------------------------------------
  # Verification (after downloading a binary and its .sig / .pem):
  #
  #   cosign verify-blob \
  #     --certificate <binary>.pem \
  #     --signature <binary>.sig \
  #     --certificate-identity-regexp '.*' \
  #     --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  #     <binary>
  #
  # SHA256SUMS and the SBOM (sks5.cdx.json) are also signed:
  #
  #   cosign verify-blob \
  #     --certificate SHA256SUMS.pem \
  #     --signature SHA256SUMS.sig \
  #     --certificate-identity-regexp '.*' \
  #     --certificate-oidc-issuer https://token.actions.githubusercontent.com \
  #     SHA256SUMS
  #
  # SLSA provenance can be verified with gh CLI:
  #
  #   gh attestation verify <binary> -R <owner>/<repo>
  # ===========================================================================
  release:
    name: GitHub Release
    needs: [gate, cross-build, extras, sbom]
    if: startsWith(github.ref, 'refs/tags/v') && needs.gate.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Download release artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts/
          pattern: '{sks5-*,sbom,completions,manpage}'
          merge-multiple: false

      - name: Collect release files
        run: |
          mkdir -p release
          find artifacts -type f -name '*.tar.gz' -exec cp {} release/ \;
          cp artifacts/sbom/sks5.cdx.json release/ 2>/dev/null || true
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum *.tar.gz sks5.cdx.json > SHA256SUMS
          echo "Generated SHA256SUMS:"
          cat SHA256SUMS

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign release artifacts with cosign (keyless / OIDC)
        run: |
          cd release

          # Sign each binary archive
          for archive in *.tar.gz; do
            echo "Signing $archive ..."
            cosign sign-blob --yes \
              --output-signature "${archive}.sig" \
              --output-certificate "${archive}.pem" \
              "$archive"
          done

          # Sign the SHA256SUMS file
          echo "Signing SHA256SUMS ..."
          cosign sign-blob --yes \
            --output-signature SHA256SUMS.sig \
            --output-certificate SHA256SUMS.pem \
            SHA256SUMS

          # Sign the SBOM
          if [ -f sks5.cdx.json ]; then
            echo "Signing sks5.cdx.json ..."
            cosign sign-blob --yes \
              --output-signature sks5.cdx.json.sig \
              --output-certificate sks5.cdx.json.pem \
              sks5.cdx.json
          fi

          echo "Cosign signing complete."
          ls -la *.sig *.pem

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            release/*.tar.gz
            release/*.tar.gz.sig
            release/*.tar.gz.pem
            release/SHA256SUMS
            release/SHA256SUMS.sig
            release/SHA256SUMS.pem
            release/sks5.cdx.json
            release/sks5.cdx.json.sig
            release/sks5.cdx.json.pem
            artifacts/completions/*
            artifacts/manpage/*

  # ===========================================================================
  # SLSA Provenance: GitHub-native build attestation (v* release only)
  # ---------------------------------------------------------------------------
  # Generates SLSA provenance for all release archives. Attestations are stored
  # in the GitHub attestation ledger and can be verified with:
  #
  #   gh attestation verify <binary> -R <owner>/<repo>
  # ===========================================================================
  provenance:
    name: SLSA Provenance
    needs: [gate, cross-build]
    if: startsWith(github.ref, 'refs/tags/v') && needs.gate.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      attestations: write
      contents: read
    strategy:
      matrix:
        include:
          - archive: sks5-x86_64-linux-gnu.tar.gz
          - archive: sks5-x86_64-linux-musl.tar.gz
          - archive: sks5-aarch64-linux-gnu.tar.gz
          - archive: sks5-aarch64-linux-musl.tar.gz
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.archive }}

      - name: Generate SLSA provenance attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: ${{ matrix.archive }}

  # ===========================================================================
  # Docker: build + scan (no push — push is in docker-push after gate)
  # ---------------------------------------------------------------------------
  # PRs/main/tags: build multi-arch images, Trivy + Grype scan, no push
  # ===========================================================================
  docker:
    name: Docker
    needs: [cross-build, lint, test, e2e-tests]
    if: |
      !cancelled() && needs.cross-build.result == 'success' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.e2e-tests.result == 'success' || needs.e2e-tests.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      # --- Always: download pre-built musl binaries from cross-build ---
      - name: Download amd64 musl artifact
        uses: actions/download-artifact@v7
        with:
          name: sks5-x86_64-linux-musl.tar.gz
          path: /tmp/artifacts/amd64

      - name: Download arm64 musl artifact
        uses: actions/download-artifact@v7
        with:
          name: sks5-aarch64-linux-musl.tar.gz
          path: /tmp/artifacts/arm64

      - name: Extract binaries for Containerfile.package
        run: |
          mkdir -p binaries/amd64 binaries/arm64
          tar xzf /tmp/artifacts/amd64/sks5-x86_64-linux-musl.tar.gz -C binaries/amd64
          tar xzf /tmp/artifacts/arm64/sks5-aarch64-linux-musl.tar.gz -C binaries/arm64
          chmod +x binaries/amd64/sks5 binaries/arm64/sks5
          ls -la binaries/amd64/ binaries/arm64/

      # --- Always: build multi-arch images (no push) ---
      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build (alpine — default)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Containerfile.package
          target: alpine
          platforms: linux/amd64,linux/arm64
          push: false
          cache-from: type=gha,scope=docker
          cache-to: type=gha,mode=max,scope=docker

      - name: Build (scratch)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Containerfile.package
          target: minimal
          platforms: linux/amd64,linux/arm64
          push: false
          cache-from: type=gha,scope=docker

      # --- Always: single-platform builds for Trivy scanning ---
      - name: Build alpine for scan (amd64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Containerfile.package
          target: alpine
          platforms: linux/amd64
          push: false
          load: true
          tags: sks5:alpine-scan
          cache-from: type=gha,scope=docker

      - name: Build scratch for scan (amd64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Containerfile.package
          target: minimal
          platforms: linux/amd64
          push: false
          load: true
          tags: sks5:scratch-scan
          cache-from: type=gha,scope=docker

      - name: Check CVE ignore expiry
        run: |
          TODAY=$(date +%Y-%m-%d)
          EXPIRED=false

          # Check .grype.yaml for expired entries
          if [ -f .grype.yaml ]; then
            while IFS= read -r line; do
              exp_date=$(echo "$line" | sed -n 's/.*#[[:space:]]*expires:[[:space:]]*\([0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}\).*/\1/p')
              if [ -n "$exp_date" ] && [ "$TODAY" \> "$exp_date" -o "$TODAY" = "$exp_date" ]; then
                cve=$(grep -B5 "$exp_date" .grype.yaml | sed -n 's/.*vulnerability:[[:space:]]*\(CVE-[^ ]*\).*/\1/p' | tail -1)
                echo "::error::Expired CVE ignore in .grype.yaml: ${cve:-unknown} (expired $exp_date)"
                EXPIRED=true
              fi
            done < .grype.yaml
          fi

          # Check .trivyignore for expired entries
          if [ -f .trivyignore ]; then
            while IFS= read -r line; do
              exp_date=$(echo "$line" | sed -n 's/.*expires:[[:space:]]*\([0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}\).*/\1/p')
              if [ -n "$exp_date" ] && [ "$TODAY" \> "$exp_date" -o "$TODAY" = "$exp_date" ]; then
                cve=$(echo "$line" | sed -n 's/^\(CVE-[^ ]*\).*/\1/p')
                echo "::error::Expired CVE ignore in .trivyignore: ${cve:-unknown} (expired $exp_date)"
                EXPIRED=true
              fi
            done < .trivyignore
          fi

          if [ "$EXPIRED" = "true" ]; then
            echo "::error::Remove expired entries or update the expiry date"
            exit 1
          fi
          echo "All CVE ignore entries are within expiry"

      - name: Cache Trivy DB
        uses: actions/cache@v5
        with:
          path: /tmp/trivy-db
          key: trivy-db-${{ github.run_id }}
          restore-keys: trivy-db-

      - name: Scan alpine image (Trivy)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: sks5:alpine-scan
          severity: CRITICAL,HIGH,MEDIUM
          exit-code: 1
          format: table
          timeout: 10m0s
          cache-dir: /tmp/trivy-db
          trivyignores: .trivyignore

      - name: Scan scratch image (Trivy)
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: sks5:scratch-scan
          severity: CRITICAL,HIGH,MEDIUM
          exit-code: 1
          format: table
          timeout: 10m0s
          cache-dir: /tmp/trivy-db
          trivyignores: .trivyignore

      - name: Install Grype
        run: curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Scan alpine image (Grype)
        run: grype sks5:alpine-scan --fail-on medium -c .grype.yaml

      - name: Scan scratch image (Grype)
        run: grype sks5:scratch-scan --fail-on medium -c .grype.yaml

  # ===========================================================================
  # Quality Gate: all checks must pass before any publish/release
  # ===========================================================================
  gate:
    name: Quality Gate
    needs: [lint, test, e2e-tests, test-msrv, security, coverage, docker, docker-lint]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate results
        run: |
          echo "Job results:"
          echo "  lint:        ${{ needs.lint.result }}"
          echo "  test:        ${{ needs.test.result }}"
          echo "  e2e-tests:   ${{ needs.e2e-tests.result }}"
          echo "  test-msrv:   ${{ needs.test-msrv.result }}"
          echo "  security:    ${{ needs.security.result }}"
          echo "  coverage:    ${{ needs.coverage.result }}"
          echo "  docker:      ${{ needs.docker.result }}"
          echo "  docker-lint: ${{ needs.docker-lint.result }}"

          # Each job must be 'success' or 'skipped' (path filter)
          # 'failure' or 'cancelled' means the gate fails
          FAILED=false
          for result in \
            "${{ needs.lint.result }}" \
            "${{ needs.test.result }}" \
            "${{ needs.e2e-tests.result }}" \
            "${{ needs.test-msrv.result }}" \
            "${{ needs.security.result }}" \
            "${{ needs.coverage.result }}" \
            "${{ needs.docker.result }}" \
            "${{ needs.docker-lint.result }}"; do
            if [ "$result" != "success" ] && [ "$result" != "skipped" ]; then
              FAILED=true
            fi
          done

          if [ "$FAILED" = "true" ]; then
            echo "::error::Quality gate failed — one or more required jobs did not succeed"
            exit 1
          fi
          echo "Quality gate passed — all required jobs succeeded or were skipped"

  # ===========================================================================
  # Docker Push: push images to GHCR + Docker Hub (tags only, after gate)
  # ===========================================================================
  docker-push:
    name: Docker Push
    needs: [gate, cross-build]
    if: startsWith(github.ref, 'refs/tags/') && needs.gate.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v6

      - name: Download amd64 musl artifact
        uses: actions/download-artifact@v7
        with:
          name: sks5-x86_64-linux-musl.tar.gz
          path: /tmp/artifacts/amd64

      - name: Download arm64 musl artifact
        uses: actions/download-artifact@v7
        with:
          name: sks5-aarch64-linux-musl.tar.gz
          path: /tmp/artifacts/arm64

      - name: Extract binaries for Containerfile.package
        run: |
          mkdir -p binaries/amd64 binaries/arm64
          tar xzf /tmp/artifacts/amd64/sks5-x86_64-linux-musl.tar.gz -C binaries/amd64
          tar xzf /tmp/artifacts/arm64/sks5-aarch64-linux-musl.tar.gz -C binaries/arm64
          chmod +x binaries/amd64/sks5 binaries/arm64/sks5
          ls -la binaries/amd64/ binaries/arm64/

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Metadata (alpine — default)
        id: meta-alpine
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}
            dockerhubgalti3r/sks5
          tags: |
            type=semver,pattern={{version}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=semver,pattern={{major}}.{{minor}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=semver,pattern={{major}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=semver,pattern={{version}}-alpine,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=raw,value=latest-alpine,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=raw,value=beta,enable=${{ startsWith(github.ref, 'refs/tags/beta-') }}
            type=raw,value=beta-alpine,enable=${{ startsWith(github.ref, 'refs/tags/beta-') }}
            type=match,pattern=beta-(.*),group=0,enable=${{ startsWith(github.ref, 'refs/tags/beta-') }}

      - name: Push (alpine — default)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Containerfile.package
          target: alpine
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta-alpine.outputs.tags }}
          labels: ${{ steps.meta-alpine.outputs.labels }}
          cache-from: type=gha,scope=docker

      - name: Metadata (scratch)
        id: meta-scratch
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}
            dockerhubgalti3r/sks5
          flavor: |
            suffix=-scratch
            latest=false
          tags: |
            type=semver,pattern={{version}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=semver,pattern={{major}}.{{minor}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=semver,pattern={{major}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=raw,value=beta,enable=${{ startsWith(github.ref, 'refs/tags/beta-') }}
            type=match,pattern=beta-(.*),group=0,enable=${{ startsWith(github.ref, 'refs/tags/beta-') }}

      - name: Push (scratch)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Containerfile.package
          target: minimal
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta-scratch.outputs.tags }}
          labels: ${{ steps.meta-scratch.outputs.labels }}
          cache-from: type=gha,scope=docker

      - name: Update Docker Hub description
        continue-on-error: true
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: dockerhubgalti3r/sks5
          readme-filepath: ./README.md
          short-description: "Lightweight SSH server with SOCKS5 proxy, shell emulation, and ACL"

  # ===========================================================================
  # Publish: crates.io + Homebrew notification (v* release only)
  # ===========================================================================
  publish-crate:
    name: Publish to crates.io
    needs: [gate, cross-build]
    if: startsWith(github.ref, 'refs/tags/v') && needs.gate.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        run: |
          cargo publish --allow-dirty 2>&1 | grep -v '^warning: ignoring test' || echo "::warning::Publish failed (crate version may already exist)"
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Update Homebrew tap
        if: success()
        continue-on-error: true
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          set -euo pipefail

          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          URL="https://github.com/galti3r/sks5/archive/refs/tags/${TAG}.tar.gz"
          SHA256=$(curl -sL "$URL" | sha256sum | cut -d' ' -f1)

          echo "::group::Updating Homebrew tap for sks5 ${VERSION}"
          echo "Tag: ${TAG}"
          echo "SHA256: ${SHA256}"

          # Clone with auth
          git clone "https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/galti3r/homebrew-sks5.git" /tmp/homebrew-sks5
          cd /tmp/homebrew-sks5
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # --- Formula: create or update ---
          mkdir -p Formula
          if [ ! -f Formula/sks5.rb ]; then
            echo "Bootstrap: creating Formula/sks5.rb"
            cat > Formula/sks5.rb << 'FORMULA'
          class Sks5 < Formula
            desc "Lightweight SSH server with SOCKS5 proxy, shell emulation, and ACL"
            homepage "https://github.com/galti3r/sks5"
            url "URL_PLACEHOLDER"
            sha256 "SHA_PLACEHOLDER"
            license "MIT"
            head "https://github.com/galti3r/sks5.git", branch: "main"

            depends_on "rust" => :build

            def install
              system "cargo", "install", "--locked", "--root", prefix, "--path", "."
              generate_completions_from_executable(bin/"sks5", "completions")
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/sks5 --version")
            end
          end
          FORMULA
          fi

          # Update url + sha256 (works for both bootstrap and update)
          sed -i "s|url \".*\"|url \"${URL}\"|" Formula/sks5.rb
          sed -i "s|sha256 \".*\"|sha256 \"${SHA256}\"|" Formula/sks5.rb

          # --- Fallback workflow: create if absent ---
          if [ ! -f .github/workflows/update-formula.yml ]; then
            echo "Bootstrap: creating .github/workflows/update-formula.yml"
            mkdir -p .github/workflows
            # Use DOLLARSIGN placeholder to prevent GitHub Actions from
            # evaluating expressions meant for the generated workflow file
            cat > .github/workflows/update-formula.yml << 'WORKFLOW'
          name: Update Formula

          on:
            repository_dispatch:
              types: [new-release]
            workflow_dispatch:
              inputs:
                version:
                  description: "Release tag (e.g. v0.1.0)"
                  required: true

          jobs:
            update:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v6

                - name: Resolve version
                  id: ver
                  run: |
                    if [ "DOLLARSIGN{{ github.event_name }}" = "repository_dispatch" ]; then
                      TAG="DOLLARSIGN{{ github.event.client_payload.version }}"
                    else
                      TAG="DOLLARSIGN{{ github.event.inputs.version }}"
                    fi
                    VERSION="${TAG#v}"
                    URL="https://github.com/galti3r/sks5/archive/refs/tags/${TAG}.tar.gz"
                    SHA256=$(curl -sL "$URL" | sha256sum | cut -d' ' -f1)
                    echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
                    echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
                    echo "url=${URL}" >> "$GITHUB_OUTPUT"
                    echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"

                - name: Update formula
                  run: |
                    sed -i "s|url \".*\"|url \"DOLLARSIGN{{ steps.ver.outputs.url }}\"|" Formula/sks5.rb
                    sed -i "s|sha256 \".*\"|sha256 \"DOLLARSIGN{{ steps.ver.outputs.sha256 }}\"|" Formula/sks5.rb

                - name: Commit and push
                  run: |
                    git config user.name "github-actions[bot]"
                    git config user.email "github-actions[bot]@users.noreply.github.com"
                    git add Formula/sks5.rb
                    git diff --cached --quiet && echo "No changes" && exit 0
                    git commit -m "feat: update sks5 to DOLLARSIGN{{ steps.ver.outputs.version }}"
                    git push
          WORKFLOW
            # Replace DOLLARSIGN placeholders with dollar-brace-brace in the generated file
            D='$'
            sed -i "s/DOLLARSIGN{{/${D}{{/g" .github/workflows/update-formula.yml
          fi

          # --- README: always regenerate with current version ---
          cat > README.md << README
          # Homebrew Tap for sks5

          Lightweight SSH server with SOCKS5 proxy, shell emulation, and ACL.

          ## Install

          \`\`\`bash
          brew tap galti3r/sks5
          brew install sks5
          \`\`\`

          ## Current version

          **${VERSION}** — [Release notes](https://github.com/galti3r/sks5/releases/tag/v${VERSION})

          ## Links

          - [Main repository](https://github.com/galti3r/sks5)
          - [Documentation](https://github.com/galti3r/sks5#readme)
          - [Issues](https://github.com/galti3r/sks5/issues)
          README
          # Remove leading whitespace from heredoc
          sed -i 's/^          //' README.md

          # --- Commit + push (idempotent) ---
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to Homebrew tap"
          else
            git commit -m "feat: update sks5 to ${VERSION}"
            git push
            echo "Homebrew tap updated to ${VERSION}"
          fi

          echo "::endgroup::"

  # ===========================================================================
  # Deploy Pages: publish screenshots and demo GIFs to GitHub Pages
  # Runs on: push to main only (after browser-e2e and vhs-demo complete)
  # ===========================================================================
  deploy-pages:
    name: Deploy to GitHub Pages
    needs: [e2e-browser, vhs-demo]
    if: >-
      github.event_name == 'push'
      && github.ref == 'refs/heads/main'
      && !cancelled()
      && (needs.e2e-browser.result == 'success' || needs.e2e-browser.result == 'skipped')
      && (needs.vhs-demo.result == 'success' || needs.vhs-demo.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download screenshots artifact
        uses: actions/download-artifact@v7
        with:
          name: dashboard-screenshots
          path: _site/screenshots
        continue-on-error: true

      - name: Download demo GIF artifact
        uses: actions/download-artifact@v7
        with:
          name: demo-gif
          path: _site
        continue-on-error: true

      - name: Download wizard GIF artifact
        uses: actions/download-artifact@v7
        with:
          name: wizard-gif
          path: _site
        continue-on-error: true

      - name: Download wizard-interactive GIF artifact
        uses: actions/download-artifact@v7
        with:
          name: wizard-interactive-gif
          path: _site
        continue-on-error: true

      - name: Verify site has content
        run: |
          if [ ! -d _site ] || [ -z "$(ls -A _site 2>/dev/null)" ]; then
            echo "No artifacts downloaded, skipping deploy"
            exit 0
          fi
          echo "Site contents:"
          find _site -type f | head -20

      - name: Setup Pages
        if: hashFiles('_site/**') != ''
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        if: hashFiles('_site/**') != ''
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        if: hashFiles('_site/**') != ''
        id: deployment
        uses: actions/deploy-pages@v4
